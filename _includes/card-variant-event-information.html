{%- assign sub_collection = page.id | split: "/" | shift | shift | first -%}
{%- assign folder_name = page.id | split: "/" | shift | shift | shift | shift | first -%}

{%- for sub_collection in site.data[page._data] -%}
    {% assign collection_name = sub_collection.name | slugify %}
    {%- if collection_name == folder_name -%}
        {%- assign current_collection = sub_collection-%}
    {% endif %}
{% endfor %}

{%- assign event_registration_link = current_collection.event_registration_link -%}
{%- assign eventDateAndTiming = current_collection.event_date | default: page.date -%}
{%- assign eventRegistrationEndDate = current_collection.event_registration_end_date -%}
{%- assign img_src = '/assets/icons/' | append: current_collection.event_category | replace: '-', '_' | replace: ' ', '_' | append: '.svg' | downcase -%}

<div class="sgds-card sgds-card-variant-video-info margin--bottom--lg" future-date="{{ eventDateAndTiming | date: '%Y%m%d' }}">
    <div class="has-text-centered" id="event-status-container">
        <p class="has-text-weight-bold has-text-white" id="event-status">PAST</p>
    </div>
    <div class="sgds-card-content padding--top padding--bottom">
        <div class="row margin--bottom--none is-flex-touch" style="justify-content: start; align-items: center;">
            <div class="col is-2 padding--right--none padding--left--none" style="font-size: 1.5em; color: #767676;">
                <span class="sgds-icon sgds-icon-calendar" role="img" aria-label="iconName"></span>
            </div>
            <div class="col is-10">
                {{- eventDateAndTiming | date: "%d %b %Y" -}}
            </div>
        </div>
        <div class="row margin--bottom--none is-flex-touch" style="justify-content: start; align-items: center;">
            <div class="col is-2 padding--right--none padding--left--none">
                <img src="{{- img_src -}}" alt="{{- img_src -}} icon" style="width: 1.5em;"
                    class="margin--bottom--none margin--right--none margin--left--none" />
            </div>
            <div class="col">
                {{- current_collection.event_category -}}
            </div>
        </div>
        <div class="row margin--bottom--none is-flex-touch" style="justify-content: start; align-items: center;">
            <div class="col is-2 padding--right--none padding--left--none" style="font-size: 1.5em; color: #767676;">
                <span class="sgds-icon sgds-icon-camera" role="img" aria-label="iconName"></span>
            </div>
            <div class="col">
                {{- current_collection.event_type -}}
            </div>
        </div>
        <div class="row">
            <div class="col padding--right--none padding--left--none">
                <button onclick="buttonEventHandler()" id="dynamic-event-button" class="sgds-button has-text-white">Register
                    now</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Pre-defining variables
    var should_run_entire_script = '{{ eventDateAndTiming }}';
    var registrationEndDate = '{{ eventRegistrationEndDate }}';
    var status, backgroundTheme, buttonText, buttonState = false;

    // Part of sidenav-second-level reusability that doesnt run on every page
    if (should_run_entire_script) {
        // To dd/mm/yy format
        function getCompareDate() {
            // gets local time, sg / kl timing
            var d = new Date(),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('');
        }

        // Dom maniuplation - to be called after the page is loaded
        // Adding attributes to elements and dynamically changing the color of the content based on the date of the event and the current time
        document.querySelectorAll('[future-date]').forEach((node) => {
            const eventButton = node.querySelector('#dynamic-event-button');

            if (node.getAttribute('future-date') < getCompareDate()) {
                // CALENDAR 
                status = 'PAST';
                backgroundTheme = "#323232";
                node.setAttribute('id', 'past-event');

                // BUTTON
                eventButton.innerHTML = "View recordings";
                eventButton.style.backgroundColor = "#0161AF";
            } else if (node.getAttribute('future-date') == getCompareDate()) {
                // CALENDAR 
                status = 'NOW';
                backgroundTheme = "#D0021B";
                node.setAttribute('id', 'upcoming-event');

                // BUTTON
                eventButton.disabled = true;
                eventButton.style.color = "white"
                eventButton.innerHTML = "Register Now";
                eventButton.style.backgroundColor = "#C6C6C6";
            } else {
                // CALENDAR 
                status = 'UPCOMING';
                backgroundTheme = "#0161AF";
                node.setAttribute('id', 'upcoming-event');

                // BUTTON
                eventButton.disabled = false;
                eventButton.innerHTML = "Register Now";
                eventButton.style.backgroundColor = "#0161AF";
            }

            for (var j = 0; j < node.querySelectorAll('[id=event-status]').length; j++) {
                node.querySelectorAll('[id=event-status]')[j].innerHTML = status;
            }

            for (var j = 0; j < node.querySelectorAll('[id=event-status-container]').length; j++) {
                node.querySelectorAll('[id=event-status-container]')[j].style.backgroundColor = backgroundTheme;
            }
        });
    }

    // Overriding the default behaviour of the button
    function buttonEventHandler() {
        if (document.querySelector('[future-date]').getAttribute('future-date') > getCompareDate()) {
            // If today's date < event date, then enable the button and redirect to the event pageÃŽ
            if('{{event_registration_link}}'){
                location.href = '{{ event_registration_link }}';
            }
        } 

        // If today's date > event date, then disable the button
        if (document.querySelector('[future-date]').getAttribute('future-date') < getCompareDate()) {
            location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
        }
    }
</script>
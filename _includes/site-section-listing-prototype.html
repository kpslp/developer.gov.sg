{% assign eventIncrementer = 0 %}
{% assign collectionDumps = 
    site.communities 
    | where_exp: "item", "item.path contains 'index.html' or item.path contains 'overview.html'" %}
{% comment %}
Filter for events that only belongs to the events sub collection.
{% endcomment %}
{% assign filteredCollectionDumps = 
    collectionDumps
    | where_exp: "item", "item.path contains '/events/conferences' or item.path contains '/events/stack-x-meetups'"
    %}
{% comment %}
Removes items that does not have any date. Helps filter events that have past, present and upcoming dates.
{% endcomment %}
{% assign sortedCollectionDumps = 
    filteredCollectionDumps 
    | where_exp: "item", "item.event_date" 
    | sort: 'event_date'  %}

<div class="card-grid-container is-fullwidth">
    {% for sub_section in sortedCollectionDumps reversed%}
        {% unless sub_section.title contains 'Past Webinars' %}
            {% if sub_section.url contains '/events' %}
                {% assign specified_category = "Conference" %}
            {% elsif sub_section.url contains '/stack-x-meetups' %}
                {% assign specified_category = "STACK-X Meetup" %}
            {% else %}
                {% assign specified_category = "Hackathons" %}
            {% endif %}

            {%- assign name = sub_section.title -%}
            {%- assign description = sub_section.description -%}
            {%- assign sub_section_slug = sub_section.name | slugify -%}
            {%- assign item_count = sub_section.items | size | minus: 1 -%}
            {%- assign url_str = sub_section.url | append : sub_section_slug  -%}
            {%- assign recordings_uploaded = sub_section.recordings_uploaded | default: false -%}
            {%- assign eventDateAndTiming = sub_section.event_date | default: sub_section.date -%}
            {%- assign img_src = '/assets/icons/' | append: specified_category | replace: '-', '_' | replace: ' ', '_' | append: '.svg' | downcase -%}

            <div future-date="{{ eventDateAndTiming | date: '%Y%m%d' }}">
                {% include card-variant-calendar.html 
                    name=name
                    item_count=item_count
                    description=description
                    img_src=img_src
                    url_str=url_str
                    eventCategory=specified_category
                    eventDateAndTiming=eventDateAndTiming
                    disableItemCount=include.disableItemCount
                %}
            </div>
        {% endunless %}
    {% endfor %}

    <div id="no-upcoming-events-message" class="margin--top margin--bottom has-text-centered">
        Sorry, there is currently no upcoming available events. Stay tune for more!
    </div>

    <div class="is-fullwidth is-flex" style="justify-content: center;">
        <a class="sgds-button sgds-button--primary" href="/communities/events/all-events/index.html">
            View all events
        </a>
    </div>
</div>

<script type="text/javascript">
    // Pre-defining variables
    let status, backgroundTheme;

    // To dd/mm/yy format
    function getCompareDate() {
        // gets local time, sg / kl timing
        var d = new Date(),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('');
    }

    // Dom maniuplation - to be called after the page is loaded
    // Adding attributes to elements and dynamically changing the color of the content based on the date of the event and the current time
    document.querySelectorAll('[future-date]').forEach((node) => {
        if (node.getAttribute('future-date') < getCompareDate()) {
            node.remove();
        } else if (node.getAttribute('future-date') == getCompareDate()) {
            status = 'NOW';
            backgroundTheme = "#D0021B";
            node.setAttribute('id', 'upcoming-event');
        } else {
            status = 'UPCOMING';
            backgroundTheme = "#0161AF";
            node.setAttribute('id', 'upcoming-event');
        }

        for (var j = 0; j < node.querySelectorAll('[id=event-status]').length; j++) {
            node.querySelectorAll('[id=event-status]')[j].innerHTML = status;
        }

        for (var j = 0; j < node.querySelectorAll('[id=event-status-container]').length; j++) {
            node.querySelectorAll('[id=event-status-container]')[j].style.backgroundColor = backgroundTheme;
        }
    });

    // After changing the color of the content, based on the number of 'present / upcoming' events, remove the no-upcoming-event element if there is any upcoming event
    if (document.querySelectorAll('[id=upcoming-event]').length > 0) {
        document.querySelector('#no-upcoming-events-message').remove();
    }

    // Given the number of upcoming events, limit the number of upcoming events to be displayed to only 2 dynamically
    if (document.querySelectorAll('[id=upcoming-event]').length > 2) {
        const removeDomArray = document.querySelectorAll('[id=upcoming-event]');
        for (var i = 1; i < lim.length; i++) {
            removeDomArray[i].remove();
        }
    }

</script>